<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Fuizlet</title>
    <link rel="stylesheet" href="../css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        /* Config Screen */
        .config-card {
            background: white;
            padding: 2.5rem;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            text-align: center;
        }

        .config-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
            text-align: left;
        }

        .option-group h3 {
            font-size: 1rem;
            margin-bottom: 0.8rem;
            color: var(--color-text-muted);
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            padding: 0.8rem;
            border: 2px solid var(--color-border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 0.5rem;
        }

        .checkbox-label:hover {
            border-color: var(--color-primary);
        }

        .checkbox-label input {
            width: 1.2rem;
            height: 1.2rem;
        }

        /* Test View */
        .question-block {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            border-left: 5px solid var(--color-border);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .question-number {
            font-weight: 700;
            color: var(--color-text-muted);
            font-size: 0.9rem;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }

        .question-text {
            font-size: 1.2rem;
            margin-bottom: 1.5rem;
            font-weight: 500;
        }

        /* Input Types */
        .text-answer {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid var(--color-border);
            border-radius: 8px;
            font-size: 1rem;
        }

        .mc-options {
            display: grid;
            gap: 0.8rem;
        }

        .mc-label {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border: 2px solid var(--color-border);
            border-radius: 8px;
            cursor: pointer;
        }

        .mc-label:hover {
            background: #f8faff;
            border-color: #cbd5e1;
        }

        /* Grading */
        .question-block.correct {
            border-left-color: #10b981;
        }

        .question-block.wrong {
            border-left-color: #ef4444;
        }

        .feedback-msg {
            margin-top: 1rem;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .feedback-msg.correct {
            color: #10b981;
        }

        .feedback-msg.wrong {
            color: #ef4444;
        }

        .result-detail {
            background: #fef2f2;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            font-size: 0.95rem;
        }

        .score-circle {
            width: 120px;
            height: 120px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: 800;
            color: var(--color-primary);
            border: 6px solid var(--color-primary);
            margin: 0 auto 1.5rem;
        }
    </style>
</head>

<body>
    <nav class="navbar">
        <a href="../index.html" class="logo">Fuizlet</a>
        <a id="back-to-set" href="set.html"
            style="margin-right: auto; margin-left: 2rem; text-decoration: none; color: #333; font-weight: 500;">‚Üê Back
            to Set</a>
        <div class="nav-links"></div>
    </nav>

    <div class="test-container">
        <div id="loading" style="text-align: center; padding: 2rem;">Loading test...</div>

        <!-- CONF FIG SCREEN -->
        <div id="config-screen" class="config-card" style="display: none;">
            <h1>Set up your test</h1>
            <p style="color: var(--color-text-muted);">Customize how you want to be tested</p>

            <div class="config-options">
                <div class="option-group">
                    <h3>Question Types</h3>
                    <label class="checkbox-label">
                        <input type="checkbox" id="type-truefalse" checked> True / False
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="type-mc" checked> Multiple Choice
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="type-written" checked> Written
                    </label>
                </div>
                <div class="option-group">
                    <h3>Question Limit</h3>
                    <label class="checkbox-label">
                        <input type="radio" name="limit" value="10" checked> 10 Questions
                    </label>
                    <label class="checkbox-label">
                        <input type="radio" name="limit" value="20"> 20 Questions
                    </label>
                    <label class="checkbox-label">
                        <input type="radio" name="limit" value="all"> All Terms
                    </label>
                </div>
            </div>

            <button id="start-btn" class="btn btn-primary btn-large" style="width: 100%;">Start Test</button>
        </div>

        <!-- TEST VIEW -->
        <div id="test-view" style="display: none;">
            <div id="questions-list"></div>
            <button id="submit-btn" class="btn btn-primary btn-large" style="width: 100%; margin-top: 2rem;">Submit
                Test</button>
        </div>

        <!-- RESULTS VIEW -->
        <div id="results-view" class="config-card" style="display: none;">
            <div class="score-circle" id="final-score">100%</div>
            <h2>Test Complete!</h2>
            <p id="score-text" style="color: var(--color-text-muted); margin-bottom: 2rem;"></p>
            <div style="display: flex; gap: 1rem; justify-content: center;">
                <button class="btn btn-primary" onclick="location.reload()">Create New Test</button>
                <a id="back-btn" href="set.html" class="btn btn-outline">Back to Set</a>
            </div>
        </div>
    </div>

    <script src="../js/supabase-config.js"></script>
    <script src="../js/app.js"></script>
    <script>
        (async () => {
            try {
                if (typeof Fuizlet === 'undefined') throw new Error("Fuizlet core library not loaded");

                Fuizlet.initNavbar();
                const params = new URLSearchParams(window.location.search);
                const setId = params.get('id');
                const set = await Fuizlet.Store.getSetById(setId);

                if (!set || !set.terms || set.terms.length === 0) {
                    window.location.href = 'sets.html';
                    return;
                }

                document.getElementById('loading').style.display = 'none';
                document.getElementById('config-screen').style.display = 'block';
                document.getElementById('back-to-set').href = 'set.html?id=' + setId;
                document.getElementById('back-btn').href = 'set.html?id=' + setId;

                // Generate test on start
                document.getElementById('start-btn').addEventListener('click', () => {
                    const useTF = document.getElementById('type-truefalse').checked;
                    const useMC = document.getElementById('type-mc').checked;
                    const useWritten = document.getElementById('type-written').checked;

                    if (!useTF && !useMC && !useWritten) {
                        alert('Please select at least one question type');
                        return;
                    }

                    // Determine question count
                    const limitVal = document.querySelector('input[name="limit"]:checked').value;
                    let limit = set.terms.length;
                    if (limitVal !== 'all') limit = Math.min(parseInt(limitVal), set.terms.length);

                    generateTest(limit, { useTF, useMC, useWritten });
                });

                let questions = [];

                function generateTest(limit, types) {
                    document.getElementById('config-screen').style.display = 'none';
                    document.getElementById('test-view').style.display = 'block';

                    // Shuffle terms
                    let shuffledTerms;
                    try {
                        shuffledTerms = Fuizlet.shuffleArray([...set.terms]).slice(0, limit);
                    } catch (e) {
                        shuffledTerms = [...set.terms].slice(0, limit);
                    }

                    const container = document.getElementById('questions-list');

                    const availableTypes = [];
                    if (types.useTF) availableTypes.push('tf');
                    if (types.useMC) availableTypes.push('mc');
                    if (types.useWritten) availableTypes.push('written');

                    shuffledTerms.forEach((term, idx) => {
                        const qType = availableTypes[Math.floor(Math.random() * availableTypes.length)];
                        const qEl = document.createElement('div');
                        qEl.className = 'question-block';
                        qEl.id = `q-${idx}`;

                        let html = `<div class="question-number">Question ${idx + 1}</div>`;

                        // Question Logic
                        let questionObj = {
                            id: idx,
                            type: qType,
                            term: term.term,
                            correctAnswer: term.definition,
                            userAnswer: null
                        };

                        if (qType === 'written') {
                            html += `<div class="question-text">${term.term}</div>`;
                            html += `<input type="text" class="text-answer" placeholder="Type the definition..." data-idx="${idx}">`;
                        }
                        else if (qType === 'mc') {
                            html += `<div class="question-text">${term.term}</div><div class="mc-options">`;

                            // Generate wrong options
                            const otherDefs = set.terms.filter(t => t.definition !== term.definition).map(t => t.definition);

                            let wrong;
                            try {
                                wrong = Fuizlet.shuffleArray(otherDefs).slice(0, 3);
                            } catch (e) { wrong = otherDefs.slice(0, 3); }

                            let opts;
                            try {
                                opts = Fuizlet.shuffleArray([term.definition, ...wrong]);
                            } catch (e) { opts = [term.definition, ...wrong]; }

                            opts.forEach(opt => {
                                html += `
                                    <label class="mc-label">
                                        <input type="radio" name="q-${idx}" value="${opt.replace(/"/g, '&quot;')}" data-idx="${idx}">
                                        ${opt}
                                    </label>
                                `;
                            });
                            html += `</div>`;
                        }
                        else if (qType === 'tf') {
                            // 50/50 chance of being true
                            const isTrue = Math.random() > 0.5;
                            const shownDef = isTrue ? term.definition :
                                (set.terms.length > 1 ? set.terms.find(t => t !== term).definition : "Incorrect def");

                            questionObj.correctAnswer = isTrue ? 'True' : 'False';
                            questionObj.isTrueFalseQuestion = true; // Flag for check logic

                            html += `<div class="question-text">${term.term}</div>`;
                            html += `<div style="background: #f8faff; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; font-style: italic;">"${shownDef}"</div>`;
                            html += `
                                <div class="mc-options">
                                    <label class="mc-label"><input type="radio" name="q-${idx}" value="True" data-idx="${idx}"> True</label>
                                    <label class="mc-label"><input type="radio" name="q-${idx}" value="False" data-idx="${idx}"> False</label>
                                </div>
                            `;
                        }

                        qEl.innerHTML = html;
                        container.appendChild(qEl);
                        questions.push(questionObj);
                    });
                }

                document.getElementById('submit-btn').addEventListener('click', () => {
                    let score = 0;

                    questions.forEach(q => {
                        const block = document.getElementById(`q-${q.id}`);
                        let userVal = '';

                        if (q.type === 'written') {
                            userVal = block.querySelector('input').value.trim();
                        } else {
                            const checked = block.querySelector('input:checked');
                            if (checked) userVal = checked.value;
                        }

                        const isCorrect = userVal.toLowerCase() === q.correctAnswer.toLowerCase();
                        if (isCorrect) score++;

                        // Visual feedback
                        block.classList.add(isCorrect ? 'correct' : 'wrong');
                        const inputs = block.querySelectorAll('input');
                        inputs.forEach(i => i.disabled = true);

                        if (!isCorrect) {
                            const feedback = document.createElement('div');
                            feedback.className = 'result-detail';
                            feedback.innerHTML = `<strong>Correct Answer:</strong> ${q.correctAnswer}`;
                            block.appendChild(feedback);
                        }
                    });

                    document.getElementById('submit-btn').style.display = 'none';
                    window.scrollTo({ top: 0, behavior: 'smooth' });

                    // Show score view at top but keep questions visible for review
                    const scoreView = document.getElementById('results-view');
                    scoreView.style.display = 'block';
                    document.querySelector('.test-container').insertBefore(scoreView, document.getElementById('test-view'));

                    const pct = Math.round((score / questions.length) * 100);
                    document.getElementById('final-score').textContent = pct + '%';
                    document.getElementById('score-text').textContent = `You got ${score} out of ${questions.length} questions correct.`;
                });
            } catch (err) {
                console.error("Initialization error:", err);
                document.getElementById('loading').innerHTML = `
                    <div style="color: #ef4444; padding: 1rem; border: 1px solid #ef4444; border-radius: 8px; background: #fef2f2;">
                        <strong>Error loading Test Mode:</strong><br>${err.message}
                        <br><br>
                        <a href="set.html${window.location.search}" class="btn btn-outline">Back to Set</a>
                    </div>
                `;
            }
        })();
    </script>
</body>

</html>